<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body></body>
  <script>
    function asyncRequest(timeout) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          console.log(timeout);
          resolve(timeout);
        }, timeout);
      });
    }

    // 异步任务队列
    async function asyncPool(limit, iterable, iteratorFn) {
      const all = [];
      const quque = new Set();

      for (let item of iterable) {
        const task = Promise.resolve(iteratorFn(item))
        all.push(task);
        task.then(() => quque.delete(task))
        quque.add(task);
        if (quque.size >= limit) {
          console.log("等待中", quque.size);
          await Promise.race(quque);
        }
      }

      return Promise.all(all);
    }

    async function start() {
      const res = await asyncPool(
        5,
        [2000, 1000, 5000, 2000, 4000, 1000],
        asyncRequest
      );
      console.log(res, "结束了");
    }

    start();
  </script>
</html>
